### Ответ на запрос пользователя

К сожалению, на данный момент Istio не предоставляет полностью нативного решения для настройки аутентификации с корпоративным Identity Provider (IdP) на основе OIDC (OAuth 2.0 + OpenID Connect), которое бы включало автоматическую переадресацию пользователей на IdP при отсутствии токена, без использования дополнительных компонентов, таких как OAuth2 Proxy. Давайте разберёмся, почему это так, и что можно сделать в рамках ваших требований.

#### Требования
- Проверка JWT, выданных корпоративным IdP.
- Автоматическая переадресация пользователей на IdP для аутентификации при отсутствии токена.
- Полный доступ для всех аутентифицированных пользователей (без дополнительной авторизации).
- Решение должно быть нативным для Istio, без развёртывания OAuth2 Proxy или других внешних компонентов в Namespace.

#### Возможности Istio
Istio предоставляет мощные инструменты для работы с аутентификацией и авторизацией, но они имеют ограничения в контексте OIDC:

1. **RequestAuthentication**  
   Этот ресурс позволяет Istio проверять JWT-токены, отправленные в запросах. Вы можете указать:
   - `issuer` (URL вашего IdP).
   - `jwksUri` (endpoint для получения ключей для валидации токенов).
   Это идеально подходит для проверки токенов, но не решает задачу переадресации на IdP, если токена нет.

2. **AuthorizationPolicy**  
   С помощью этого ресурса можно настроить правила доступа, например, разрешить доступ только запросам с валидным JWT. Однако он также не поддерживает инициирование потока аутентификации OIDC.

3. **EnvoyFilter**  
   Istio использует Envoy как прокси, и через EnvoyFilter можно настраивать его поведение напрямую. Envoy поддерживает фильтры, такие как `ext_authz`, но они требуют внешнего сервиса авторизации, что не соответствует вашему требованию.

#### Проблема с переадресацией
Istio отлично справляется с проверкой существующих JWT-токенов, но не имеет встроенного механизма для реализации полного потока OIDC, включая переадресацию пользователей на страницу входа IdP при отсутствии токена. В стандартных сценариях OIDC такая переадресация (редирект на `/authorize` endpoint IdP) обрабатывается внешним компонентом, например, OAuth2 Proxy, который:
- Проверяет наличие токена.
- Перенаправляет пользователя на IdP, если токена нет.
- Получает токен после аутентификации и передаёт его в запрос.

Без такого посредника Istio может только отклонить запрос с ошибкой 401 (Unauthorized), но не инициировать переадресацию.

#### Почему полностью нативное решение невозможно?
- **Отсутствие встроенной поддержки OIDC-редиректа**: Istio фокусируется на проверке токенов и управлении трафиком, но не на реализации клиентской части OIDC-потока (редирект, получение токена).
- **Ограничения CUSTOM действия в AuthorizationPolicy**: Начиная с Istio 1.9, вы можете делегировать авторизацию внешнему сервису через `CUSTOM` действие, но это требует развёртывания такого сервиса (например, OAuth2 Proxy), что противоречит вашему требованию.

#### Частичное нативное решение
Вы можете настроить Istio для проверки JWT без дополнительных компонентов. Вот пример конфигурации:

```yaml
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: your-namespace
spec:
  selector:
    matchLabels:
      app: your-app
  jwtRules:
  - issuer: "https://your-idp.example.com"
    jwksUri: "https://your-idp.example.com/.well-known/jwks.json"
```

Эта конфигурация заставит Istio проверять JWT в запросах к вашему приложению. Если токен валиден, запрос будет обработан. Если токена нет или он невалиден, Istio вернёт ошибку 401. Однако автоматической переадресации на IdP не произойдёт.

#### Рекомендуемое решение с минимальным отклонением
Поскольку полностью нативное решение невозможно, рассмотрите компромиссный вариант: использование OAuth2 Proxy, но не в вашем Namespace, а в отдельном централизованном Namespace. Это позволит:
- Делегировать переадресацию и получение токена OAuth2 Proxy.
- Использовать Istio для проверки JWT и управления доступом.

Шаги настройки:
1. **Разверните OAuth2 Proxy** в отдельном Namespace, например, `auth-system`.
2. **Настройте OAuth2 Proxy** для работы с вашим IdP:
   - Укажите `client_id`, `client_secret`, `redirect_uri`.
   - Настройте endpoint’ы IdP (authorization, token, JWKS).
3. **Настройте Istio AuthorizationPolicy с CUSTOM действием**:
   ```yaml
   apiVersion: security.istio.io/v1beta1
   kind: AuthorizationPolicy
   metadata:
     name: ext-authz
     namespace: your-namespace
   spec:
     selector:
       matchLabels:
         app: your-app
     action: CUSTOM
     provider:
       name: "oauth2-proxy"
   ```
4. **Настройте RequestAuthentication** (как в примере выше) для проверки JWT после получения токена.

OAuth2 Proxy будет перенаправлять пользователей на IdP, получать токен и добавлять его в заголовки запроса, а Istio проверит токен и пропустит запрос.

#### Свежие best practices
- **Istio 1.9+**: Используйте `CUSTOM` действие в AuthorizationPolicy для интеграции с внешними сервисами авторизации.
- **Централизация**: Разворачивайте OAuth2 Proxy централизованно для нескольких приложений.
- **Безопасность**: Используйте TLS для всех взаимодействий между Istio, OAuth2 Proxy и IdP.
- **WASM плагины**: В перспективе можно рассмотреть написание WebAssembly-плагина для Envoy, чтобы добавить поддержку OIDC-редиректа, но это требует значительных усилий и пока не является стандартной практикой.

#### Примеры реализации
Полностью нативных примеров без OAuth2 Proxy нет, но вы можете адаптировать существующие руководства:
- [Istio External Authorization](https://istio.io/latest/docs/tasks/security/authorization/authz-custom/).
- [Securing Kubernetes with Istio and OAuth2-Proxy](https://www.jetstack.io/blog/securing-kubernetes-with-istio-and-oauth2-proxy/).

#### Заключение
Istio не поддерживает полностью нативную аутентификацию OIDC с переадресацией на IdP без дополнительных компонентов. Для проверки JWT используйте `RequestAuthentication`, но для переадресации на IdP потребуется внешний сервис, например, OAuth2 Proxy, развёрнутый вне вашего Namespace. Это наиболее практичный и поддерживаемый подход на текущий момент.