# as-env

''' find /usr/bin /usr/local/bin /usr/sbin /sbin /bin /lib /lib64 /usr/lib /usr/lib64 /opt /usr/libexec \
  -type f \( -executable -o -name "*.so*" -o -name "*.a" \) -print0 | sort -z | xargs -0 sha256sum'''


find /usr/bin /usr/local/bin /usr/sbin /sbin /bin /lib /lib64 /usr/lib /usr/lib64 /opt /usr/libexec \
  -type f \( -executable -o -name "*.so*" -o -name "*.a" \) -print0 | sort -z | xargs -0 sha256sum


–¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–º–µ—Ç–∏–ª –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:  
- **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** (–Ω–µ —Ç–æ–ª—å–∫–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –Ω–æ –∏ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `rmondl`).  
- **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏** (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–∑ `root`).  
- **–£–ø–∞–∫–æ–≤–∞—Ç—å –≤—Å—ë –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (Docker/Podman) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.  

---

## **1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

–¢—ã —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ `ldd` –ø–æ–∫–∞–∑–∞–ª. –û–¥–Ω–∞–∫–æ —ç—Ç–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ù–∞–º –Ω—É–∂–Ω–æ –≤—ã—è—Å–Ω–∏—Ç—å:  
‚úÖ **–ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç?**  
‚úÖ **–ö–∞–∫–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π?**  
‚úÖ **–ö–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/—Å–æ–∫–µ—Ç—ã –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç?**  

### **1.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
–ò—Å–ø–æ–ª—å–∑—É–π `strace`, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏—â–µ—Ç `rmondl`:  
```bash
strace -f -e trace=openat,access,stat,readlink ./rmondl 2>&1 | tee strace_open.log
```
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏—â–∏ –æ—à–∏–±–∫–∏ `ENOENT` (—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω) –≤ –ª–æ–≥–µ:  
```bash
grep 'ENOENT' strace_open.log
```
–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤–∏–¥–∏—à—å —Å—Ç—Ä–æ–∫—É:  
```
openat(AT_FDCWD, "/etc/rmondl.conf", O_RDONLY) = -1 ENOENT (No such file or directory)
```
–∑–Ω–∞—á–∏—Ç, –Ω–∞–¥–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

---

### **1.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π**
–ó–∞–ø—É—Å–∫–∞–µ–º `strace`, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –æ—à–∏–±–∫–∏ `EPERM (Operation not permitted)`:  
```bash
strace -f -e trace=capset,setuid,setgid,prctl,clone ./rmondl 2>&1 | tee strace_priv.log
```
–ó–∞—Ç–µ–º –∏—â–µ–º –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–µ:  
```bash
grep 'EPERM' strace_priv.log
```
–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
```
prctl(PR_SET_DUMPABLE, 0) = -1 EPERM (Operation not permitted)
setuid(0) = -1 EPERM (Operation not permitted)
capset(...) = -1 EPERM (Operation not permitted)
```
—ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–±—É–µ—Ç **—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ Linux capabilities** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `CAP_NET_BIND_SERVICE`, `CAP_SYS_ADMIN`).

---

### **1.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ç—å—é**
–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã —Ç—Ä–µ–±—É—é—Ç `root`, –µ—Å–ª–∏ —Å–ª—É—à–∞—é—Ç **–ø–æ—Ä—Ç—ã –Ω–∏–∂–µ 1024**. –ü—Ä–æ–≤–µ—Ä–∏–º:
```bash
strace -f -e trace=socket,bind,connect,listen ./rmondl 2>&1 | tee strace_net.log
```
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ `EACCES` –∏–ª–∏ `EPERM`:  
```bash
grep -E 'EACCES|EPERM' strace_net.log
```
–ï—Å–ª–∏ –≤–∏–¥–∏—à—å:
```
bind(3, {sa_family=AF_INET, sin_port=htons(443)}, 16) = -1 EACCES (Permission denied)
```
—Ç–æ **–ª–∏–±–æ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8080), –ª–∏–±–æ –¥–∞—Ç—å capability `CAP_NET_BIND_SERVICE`**.

---

### **1.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ `/dev`**
–ï—Å–ª–∏ `rmondl` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–µ–ª–µ–∑–æ (—Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, —Ñ–∞–π–ª—ã `/dev/`), –Ω–∞–π–¥–µ–º –∏—Ö:
```bash
strace -f -e trace=openat ./rmondl 2>&1 | tee strace_dev.log
grep '/dev/' strace_dev.log
```
–ï—Å–ª–∏ –æ–Ω –æ–±—Ä–∞—â–∞–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫ `/dev/shm` –∏–ª–∏ `/dev/net/tun`, —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

---

## **2. –ó–∞–ø—É—Å–∫ –±–µ–∑ `root` —Å –Ω—É–∂–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏**
–î–æ–ø—É—Å—Ç–∏–º, –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –≤—ã—è—Å–Ω–∏–ª–∏, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –Ω—É–∂–Ω—ã:
‚úÖ `CAP_NET_BIND_SERVICE` (–µ—Å–ª–∏ –æ–Ω–∞ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç—ã –Ω–∏–∂–µ 1024)  
‚úÖ `CAP_SYS_ADMIN` (–µ—Å–ª–∏ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç `prctl` –∏–ª–∏ `mount` –æ–ø–µ—Ä–∞—Ü–∏–∏)  
‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `/etc/rmondl.conf`, `/var/log/rmondl.log`  

### **2.1. –î–æ–±–∞–≤–ª—è–µ–º `capabilities`**
–í `Dockerfile` –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å:
```dockerfile
FROM rhel8

# –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY rmondl /usr/local/bin/
COPY lib/* /usr/lib/

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd -r -s /bin/false rmondl

# –î–∞—ë–º –ø—Ä–æ–≥—Ä–∞–º–º–µ –Ω—É–∂–Ω—ã–µ –∫–∞–ø–∞–±–∏–ª–∏—Ç–∏
RUN setcap CAP_NET_BIND_SERVICE,CAP_SYS_ADMIN+ep /usr/local/bin/rmondl

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ root
USER rmondl

ENTRYPOINT ["/usr/local/bin/rmondl"]
```

---

### **2.2. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏**
–ï—Å–ª–∏ `setcap` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å `cap_add`:
```bash
podman run --cap-add=NET_BIND_SERVICE --cap-add=SYS_ADMIN my_rmondl
```
–∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ –Ω—É–∂–Ω–æ–≥–æ:
```bash
podman run --security-opt="no-new-privileges" --cap-add=NET_BIND_SERVICE my_rmondl
```

---

### **3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º `strace`, –Ω–æ —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
podman run --rm my_rmondl strace -f ./rmondl
```
–ï—Å–ª–∏ –æ—à–∏–±–æ–∫ `EPERM` –±–æ–ª—å—à–µ –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç, –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

---

### **–í—ã–≤–æ–¥**
1. **–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**  
   - `ldd` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.  
   - `strace` –≤—ã—è–≤–ª—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∞–π–ª—ã –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏.  
2. **–î–∞—ë–º –Ω—É–∂–Ω—ã–µ `capabilities`** —á–µ—Ä–µ–∑ `setcap` –∏–ª–∏ `--cap-add` –≤ Podman.  
3. **–ó–∞–ø—É—Å–∫–∞–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –±–µ–∑ root**, –Ω–æ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.  

–ü–æ–ø—Ä–æ–±—É–π –ø—Ä–æ–π—Ç–∏ —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏ —Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å! üöÄ
